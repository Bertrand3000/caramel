{% extends 'base.html.twig' %}

{% block title %}Panier{% endblock %}

{% block body %}
    <main class="container py-4">
        <h1 class="h3 mb-3">Mon panier</h1>

        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ type == 'error' ? 'danger' : type }}">{{ message }}</div>
            {% endfor %}
        {% endfor %}

        <p class="mb-3">
            Expiration des réservations :
            <span id="countdown" class="fw-bold">--:--</span>
        </p>

        <div class="list-group mb-3">
            {% for item in items %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ item.produit.libelle }}</strong><br>
                        <small>Quantité : {{ item.quantite }}</small>
                    </div>
                    <form method="post" action="{{ path('cart_remove', {id: item.produit.id}) }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Retirer</button>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-light border">Votre panier est vide.</div>
            {% endfor %}
        </div>

        <div class="d-flex gap-2">
            {% if hasItems %}
                <a class="btn btn-primary" href="{{ path('checkout_creneaux') }}">Valider ma commande</a>
                <form method="post" action="{{ path('cart_clear') }}">
                    <button class="btn btn-outline-secondary" type="submit">Vider le panier</button>
                </form>
            {% endif %}
            {% if canContinueShopping %}
                <a class="btn btn-outline-primary" href="{{ path('shop_catalogue') }}">Continuer vos achats</a>
            {% endif %}
        </div>
    </main>

    <script>
        (() => {
            const expireAt = {{ expireAt is not null ? expireAt : 'null' }};
            const node = document.getElementById('countdown');
            if (!node || expireAt === null) {
                node.textContent = 'Panier vide';
                return;
            }

            const render = () => {
                const remaining = Math.max(0, expireAt - Math.floor(Date.now() / 1000));
                const minutes = String(Math.floor(remaining / 60)).padStart(2, '0');
                const seconds = String(remaining % 60).padStart(2, '0');
                node.textContent = `${minutes}:${seconds}`;
            };

            render();
            setInterval(render, 1000);
        })();
    </script>
{% endblock %}
