{% extends 'base.html.twig' %}

{% block title %}Préparation des commandes{% endblock %}

{% block body %}
<main class="container py-4">
    <section class="form-shell dmax-list-shell">

        <div class="layout-flashes mb-3">
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label == 'error' ? 'danger' : label }} alert-global" role="alert">{{ message }}</div>
                {% endfor %}
            {% endfor %}
        </div>

        <header class="dmax-list-head">
            <div>
                <h1>Préparation des commandes</h1>
                {% if jour %}
                    <p class="dmax-list-meta mb-0">
                        Prochain jour de livraison : <strong>{{ jour.date|date('d/m/Y') }}</strong>
                        — {{ commandes|length }} commande(s) à traiter.
                    </p>
                {% endif %}
            </div>
        </header>

        {% if jour is null %}
            <div class="alert alert-warning">
                Aucun jour de livraison actif trouvé. Veuillez en créer un dans
                <a href="{{ path('admin_jours_livraison_index') }}">l'administration des créneaux</a>.
            </div>
        {% elseif commandes is empty %}
            <div class="alert alert-info">
                Aucune commande à préparer pour le {{ jour.date|date('d/m/Y') }}.
            </div>
        {% else %}
            <div class="dmax-table-wrap">
                <table class="dmax-table">
                    <thead>
                        <tr>
                            <th>Emplacement</th>
                            <th>Produit(s)</th>
                            <th>N° inventaire</th>
                            <th>Créneau</th>
                            <th>Agent</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for commande in commandes %}
                            <tr>
                                <td>
                                    {% for ligne in commande.lignesCommande %}
                                        <div class="text-nowrap">
                                            Ét.&nbsp;{{ ligne.produit.etage }}&nbsp;/&nbsp;P.&nbsp;{{ ligne.produit.porte }}
                                        </div>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for ligne in commande.lignesCommande %}
                                        <div>{{ ligne.produit.libelle }}</div>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for ligne in commande.lignesCommande %}
                                        <div class="text-muted small">{{ ligne.produit.numeroInventaire ?: '—' }}</div>
                                    {% endfor %}
                                </td>
                                <td class="text-nowrap">
                                    {% if commande.creneau %}
                                        {{ commande.creneau.heureDebut|date('H:i') }} – {{ commande.creneau.heureFin|date('H:i') }}
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">
                                    {{ commande.prenom ?: '—' }} {{ commande.nom ?: '' }}
                                    {% if commande.numeroAgent %}
                                        <div class="text-muted small">#{{ commande.numeroAgent }}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if commande.statut.value == 'validee' %}
                                        <span class="badge text-bg-warning">Validée</span>
                                    {% elseif commande.statut.value == 'en_preparation' %}
                                        <span class="badge text-bg-primary">En préparation</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if commande.statut.value == 'validee' %}
                                        <form method="post" action="{{ path('logistique_commande_en_preparation', {id: commande.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('en_preparation_' ~ commande.id) }}">
                                            <button type="submit" class="btn btn-sm btn-outline-primary text-nowrap">
                                                Démarrer
                                            </button>
                                        </form>
                                    {% elseif commande.statut.value == 'en_preparation' %}
                                        <div class="d-flex flex-column gap-1">
                                            <form method="post" action="{{ path('logistique_commande_prete', {id: commande.id}) }}">
                                                <input type="hidden" name="_token" value="{{ csrf_token('prete_' ~ commande.id) }}">
                                                <button type="submit" class="btn btn-sm btn-success text-nowrap w-100">
                                                    Marquer prête
                                                </button>
                                            </form>
                                            <form method="post" action="{{ path('logistique_commande_retour_validee', {id: commande.id}) }}">
                                                <input type="hidden" name="_token" value="{{ csrf_token('retour_validee_' ~ commande.id) }}">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary text-nowrap w-100">
                                                    ↩ À préparer
                                                </button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

    </section>
</main>
{% endblock %}
